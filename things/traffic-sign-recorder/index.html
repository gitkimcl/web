<!DOCTYPE html>
<html>
	<head>
		<link href="https://fonts.googleapis.com/css2?family=Lato:wght@300&display=swap" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@700&display=swap" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
		<link rel="stylesheet" href="style.css">
		<script  type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	</head>
	<body>
		<div class="basic-dark-mode">
		</div>
		<div class="time">
			<p class="header">
				기록계 버전 0.0.4
			</p>
			<br>
			<h1 class="hour">00</h1>
			<h1 class="up">:</h1>
			<h1 class="minute">00</h1>
			<h1 class="second">00</h1>
		</div>
		<div class="container">
			<table>
				<tr>
					<th>번호</th>
					<th>신호등#</th>
					<th>시간</th>
					<th>시간 간격</th>
				</tr>
			</table>
		</div>
		<script>
			function save(key,str1,str2,str3) {
				key=String(key);
				localStorage.setItem(key+"_str1",str1);
				localStorage.setItem(key+"_str2",str2);
				localStorage.setItem(key+"_str3",str3);
			}
			function load_all() {
				// TODO
			}
			var now=new Date();
			if (now.getHours() < 20 || 7 < now.getHours()) {
				$(".basic-dark-mode").css("background-color","#00000088");
			}
			$(".basic-dark-mode").css("transitions","background-color 1s");
			function ify(str,num) {		// ...ify
				str=String(str);
				while (str.length < num) {
					str = "0" + str;
				}
				return str;
			}
			function wait(str1,str2,str3,str4) {
				// 재귀함수 같은 재귀함수 아닌 재귀함수 아닌거
				if ($(target1).is(":focus") || $(target3).is(":focus") || $(target2).is(":focus") || $(target4).is(":focus")) {
					setTimeout(wait,100,$(target1).val(),$(target2).val(),$(target3).val(),$(target4).val())
				} else if (str1!="" && str2!="" && str3!="" && str4!="") {
					closeTable(i);
					i++;
					setTimeout(round, 100);
				} else {
					setTimeout(wait,100, $(target1).val(),$(target2).val(),$(target3).val(),$(target4).val());
				}
			}
			function updateTime() {
				now = new Date();
				$(".time .hour").text(ify(now.getHours(),2));
				$(".time .minute").text(ify(now.getMinutes(),2));
				$(".time .second").text(ify(now.getSeconds(),2));
				if (now.getHours() > 20 || 7 > now.getHours()) {
					$(".basic-dark-mode").css("background-color","#00000066");
				} else {
					$(".basic-dark-mode").css("background-color","#00000000");
				}
			}
			var $table=$(".container table");
			function addTable() {
				var $element=$("<tr></tr>");
				$element.append($("<td></td>").text("-"));
				$element.append($("<td></td>"));
				$element.append($("<td></td>"));
				$element.append($("<td></td>"));
				$table.append($element);
			}
			function openTable(num) {
				var $target1=$(".container table tr:nth-child("+(num+1)+") td:nth-child(1)");
				var $target2=$(".container table tr:nth-child("+(num+1)+") td:nth-child(2)");
				var $target3=$(".container table tr:nth-child("+(num+1)+") td:nth-child(3)");
				if (!$target1.length) {	// target1이 존재하지 않으면
					addTable();
					$target1=$(".container table tr:nth-child("+(num+1)+") td:nth-child(1)");
					$target2=$(".container table tr:nth-child("+(num+1)+") td:nth-child(2)");
					$target3=$(".container table tr:nth-child("+(num+1)+") td:nth-child(3)");
				}
				$target1.text(num);
				$target2.append($("<input type='number' placeholder='번호'></input>"));
				$target3.append($("<input type='number' placeholder='시'></input>"));
				$target3.append($("<input type='number' placeholder='분'></input>"));
				$target3.append($("<input type='number' placeholder='초'></input>"));
			}
			function closeTable(num) {
				var $target1=$(".container table tr:nth-child("+(num+1)+") td:nth-child(1)");
				var $col1=$(".container table tr:nth-child("+(num+1)+") td:nth-child(2)");
				var $col1_=undefined;
				var $col2_=undefined;
				var $col2=$(".container table tr:nth-child("+(num+1)+") td:nth-child(3)");
				var $col3=$(".container table tr:nth-child("+(num+1)+") td:nth-child(4)");
				var $input1=$(".container table tr:nth-child("+(num+1)+") td:nth-child(2) input");
				var $input2=$(".container table tr:nth-child("+(num+1)+") td:nth-child(3) input:nth-child(1)");
				var $input3=$(".container table tr:nth-child("+(num+1)+") td:nth-child(3) input:nth-child(2)");
				var $input4=$(".container table tr:nth-child("+(num+1)+") td:nth-child(3) input:nth-child(3)");
				var text1 = $input1.val();
				var text2 = ify($input2.val()*3600+$input3.val()*60+$input4.val()*1,5);
				$col1.text(text1);
				$col2.text(text2);
				var j;
				for (j=num; j>1; j--) {
					$col1_ = $(".container table tr:nth-child("+j+") td:nth-child(2)");
					if ($col1_.text() == $input1.val()) {
						$col2_=$(".container table tr:nth-child("+j+") td:nth-child(3)");
						break;
					}
				}
				if ($col2_==undefined) {
					$col3.text(0);
				} else {
					$col3.text($col2.text()-$col2_.text());
				}
				$input1.remove();
				$input2.remove();
				save($target1.text(), $col1.text(),$col2.text(),$col3.text());
			}
			var target1;
			var target2;
			var target3;
			var target4;
			var target5;
			for (var i=1;i<=29;i++) {
				addTable();
			}
			i=1;
			setInterval(updateTime, 11);
			round();
			function round() {
				openTable(i);
				target1=".container table tr:nth-child("+(i+1)+") td:nth-child(2) input";
				target2=".container table tr:nth-child("+(i+1)+") td:nth-child(3) input:nth-child(1)";
				target3=".container table tr:nth-child("+(i+1)+") td:nth-child(3) input:nth-child(2)";
				target4=".container table tr:nth-child("+(i+1)+") td:nth-child(3) input:nth-child(3)";
				wait($(target1).val(),$(target2).val(),$(target3).val(),$(target4).val());
			} // oh my
		</script>
	</body>
</html>